# My Toolbox

## 下準備

プロジェクトディレクトリのルートで下準備。

```
$ mkdir project
$ cd project
$ npm init
```

package.json
```json
{
  "name": "hoge",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "MIT"
}
```

.gitignoreをNode用で作っておく。giboってので作ってる。

```
$ gibo Node | tee .gitignore
```

.gitignoreの中身はこんな感じ。

```
### https://raw.github.com/github/gitignore/7adc93eed241301cd4e5e6860983dbba1d63e000/Node.gitignore

# Logs
logs
*.log
npm-debug.log*

# Runtime data
pids
*.pid
*.seed

# Directory for instrumented libs generated by jscoverage/JSCover
lib-cov

# Coverage directory used by tools like istanbul
coverage

# Grunt intermediate storage (http://gruntjs.com/creating-plugins#storing-task-files)
.grunt

# node-waf configuration
.lock-wscript

# Compiled binary addons (http://nodejs.org/api/addons.html)
build/Release

# Dependency directory
# https://docs.npmjs.com/misc/faq#should-i-check-my-node-modules-folder-into-git
node_modules

# Optional npm cache directory
.npm

# Optional REPL history
.node_repl_history
```


gulpと必要なものを入れる。

```
$ npm install --save-dev gulp gulp-load-plugins del
```

gulpfile.jsを作る

```javascript
var path = require('path');
var pkg = require('./package.json');
var distDir = path.join(__dirname, pkg.dist);
var gulp = require('gulp');
var $ = require('gulp-load-plugins')();
var del = require('del');

gulp.task('clean', del.bind(null, [distDir]));

gulp.task('dev', [], () => {

});

gulp.task('default', ['clean'], () => {
  gulp.start('dev');
});
```

package.jsonに設定追加。

```json

-- 中略 --

  "dist": "dist",
  "scripts": {
    "gulp": "gulp",
    "test": "echo \"Error: no test specified\" && exit 1"
  },

-- 中略 --

```

.gitignoreにdistを追加。

```
dist

### https://raw.github.com/github/gitignore/7adc93eed241301cd4e5e6860983dbba1d63e000/Node.gitignore

-- 中略 --

```

これでgulpはこんな感じに使う。

```
$ npm run gulp
```

```
.
├── app
│   ├── images
│   ├── scripts
│   └── styles
├── dist
├── gulpfile.js
├── node_modules
└── package.json
```


## HTMLと開発用Webサーバ

開発用Webサーバはconnectを使ってる。

```
$ npm install --save-dev connect connect-livereload serve-static gulp-livereload
```

app/index.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hello World!</title>
</head>
<body>
  <h1>Hello World!</h1>
</body>
</html>
```

gulpfile.js

```javascript

-- 中略 --

var connect = require('connect');
var connectLivereload = require('connect-livereload');
var serveStatic = require('serve-static');

-- 中略 --

gulp.task('html', () => {
  return gulp.src('app/**/*.html')
  .pipe(gulp.dest(distDir))
  .pipe($.livereload());
});

gulp.task('serve', () => {
  $.livereload.listen();
  connect()
  .use(connectLivereload())
  .use(serveStatic(distDir))
  .listen(3100);
});

gulp.task('dev', ['html', 'serve'], () => {
  gulp.watch('app/**/*.html', ['html']);
});

-- 中略 --

```



## CSSまわり（Bootstrap3）

```
$ npm install --save bootstrap
$ npm install --save-dev gulp-less
```

app/styles/app.less

```less
@import '../../node_modules/bootstrap/less/bootstrap.less';

body {
  background-color: #efffef;
}
```

app/index.html

```html
-- 中略 --
<head>
  <meta charset="UTF-8">
  <title>Hello World!</title>
  <link rel="stylesheet" href="./styles/app.css" />
</head>

-- 中略 --

```

gulpfile.js

```javascript

-- 中略 --

gulp.task('styles:dev', ['less:dev', 'fonts', 'images']);

gulp.task('less:dev', () => {
  return gulp.src('app/styles/**/*.less')
  .pipe($.less({
    paths: [
      'node_modules/bootstrap/less'
    ]
  }))
  .pipe(gulp.dest(path.join(distDir, 'styles')))
  .pipe($.livereload());
});

gulp.task('fonts', () => {
  return gulp.src([
    'node_modules/bootstrap/fonts/*'
  ])
  .pipe(gulp.dest(path.join(distDir, 'fonts')));
});

gulp.task('images', () => {
  return gulp.src([
    'app/images/**/*'
  ])
  .pipe(gulp.dest(path.join(distDir, 'images')));
});


-- 中略 --

gulp.task('dev', ['html', 'styles:dev', 'serve'], () => {
  gulp.watch('app/**/*.html', ['html']);
  gulp.watch('app/styles/**/*.less', ['less:dev']);
});

-- 中略 --

```



## JavaScriptまわり

```
$ npm install --save-dev webpack babel-loader babel-preset-es2015 gulp-util
```

.babelrc

```json
{
  "presets": ["es2015"]
}
```

webpack.config.js

```javascript
var path = require('path');
var pkg = require('./package.json');
var distDir = path.join(__dirname, pkg.dist);

module.exports = {
  entry: {
    app: './app/scripts/app.js'
  },
  output: {
    path: path.join(distDir, 'scripts'),
    filename: '[name].js'
  },
  devtool: 'inline-source-map',
  module: {
    loaders: [
      {
        test: /\.js$/,
        exclude: /node_modules/,
        loader: 'babel'
      }
    ]
  }
};
```

gulpfile.js

```javascript

-- 中略 --

var webpack = require('webpack');
var bundler = webpack(require('./webpack.config.js'));

-- 中略 --

gulp.task('bundle:dev', cb => {
  bundler.run((err, stats) => {
    if (err) {
      throw new $.util.PluginError('webpack:build', err);
    }
    $.util.log('[webpack:build]', stats.toString({
      colors: true,
      chunkModules: false
    }));
    cb();
    $.livereload.reload();
  });
});

-- 中略 --

gulp.task('dev', ['html', 'styles:dev', 'bundle:dev', 'serve'], () => {
  gulp.watch('app/**/*.html', ['html']);
  gulp.watch('app/styles/**/*.less', ['less:dev']);
  gulp.watch('app/scripts/**/*.js', ['bundle:dev']);
});

-- 中略 --

```


app/scripts/Hoge.js

```javascript
export default class Hoge {

  constructor(name) {
    this._name = name;
  }

  greet() {
    return `Hello! ${this._name}`;
  }
}
```

app/scripts/app.js

```javascript
import Hoge from './Hoge';

const hoge = new Hoge('test');

console.log(hoge.greet());
```


app/index.html

```html
-- 中略 --
<body>
  <h1>Hello World!</h1>
  <script src="./scripts/app.js"></script>
</body>
</html>
```


## プロダクション用のビルド

```
$ npm install --save-dev gulp-zip gulp-minify-css
```

```javascript
-- 中略 --
function less() {
  return gulp.src('app/styles/**/*.less')
  .pipe($.less({
    paths: [
      'node_modules/bootstrap/less'
    ]
  }));
}

-- 中略 --

gulp.task('styles:prod', ['less:prod', 'fonts', 'images']);

gulp.task('less:dev', () => {
  return less()
  .pipe(gulp.dest(path.join(distDir, 'styles')))
  .pipe($.livereload());
});

gulp.task('less:prod', () => {
  return less()
  .pipe($.minifyCss())
  .pipe(gulp.dest(path.join(distDir, 'styles')))
});

-- 中略 --

gulp.task('bundle:prod', cb => {
  webpack(require('./webpack.production.config.js'), cb);
});

-- 中略 --

gulp.task('prod', ['html', 'styles:prod', 'bundle:prod'], () => {
  return gulp.src(path.join(distDir, '**/*'))
  .pipe($.zip(pkg.name + '.zip'))
  .pipe(gulp.dest('build'));
});

gulp.task('build', ['clean'], () => {
  gulp.start('prod');
});

-- 中略 --
```

webpack.common.js

```javascript
var path = require('path');
var pkg = require('./package.json');
var distDir = path.join(__dirname, pkg.dist);

module.exports = function() {
  return {
    entry: {
      app: './app/scripts/app.js'
    },
    output: {
      path: path.join(distDir, 'scripts'),
      filename: '[name].js'
    },
    module: {
      loaders: [
        {
          test: /\.js$/,
          exclude: /node_modules/,
          loader: 'babel'
        }
      ]
    }
  };
};
```

webpack.config.js

```javascript
var config = require('./webpack.common.js')();
config.devtool = 'inline-source-map';

module.exports = config;
```


webpack.production.config.js

```javascript
var config = require('./webpack.common.js')();
var webpack = require('webpack');
config.plugins = [
  new webpack.optimize.UglifyJsPlugin({
    compress: {
      warnings: false
    }
  })
];

module.exports = config;
```

.gitignore

```
dist
build

-- 中略 --
```

package.json

```json
-- 中略 --
  "scripts": {
    "gulp": "gulp",
    "build": "gulp build"
  },
-- 中略 --
```


## テスト環境

```
$ npm install --save-dev mocha power-assert espower-babel
```

test/mocha.opts

```
--compilers js:espower-babel/guess
```

test/Hoge-test.js

```javascript
import Hoge from '../app/scripts/Hoge';
import assert from 'power-assert';

describe('Hoge', () => {

  const name = 'Test';
  let hoge;
  beforeEach(() => {
    hoge = new Hoge(name);
  });

  describe('#greet', () => {
    it('returns greet message', () => {
      assert(hoge.greet() === `Hello! ${name}`);
    });
  });

});
```


package.json

```json
-- 中略 --
  "scripts": {
    "gulp": "gulp",
    "build": "gulp build",
    "mocha": "mocha",
    "test": "mocha test/*-test.js"
  },
-- 中略 --
```

```
$ npm run test
```

## APIサーバとの連携

```
$ npm install --save-dev http-proxy-middleware
```

gulefile.js

```javascript

-- 中略 --

var proxyMiddleware = require('http-proxy-middleware');

-- 中略 --

gulp.task('serve', () => {
  var port = process.env.API_PORT || 3000;

  $.livereload.listen();
  connect()
  .use(connectLivereload())
  .use(serveStatic(distDir))
  .use(proxyMiddleware([
    '/api'
  ], {
    target: 'http://localhost:' + port,
    changeOrigin: true
  }))
  .listen(3100);
});

-- 中略 --

```


app/scripts/Hoge.js


```javascript
export default class Hoge {

-- 中略 --

  fetchGreet() {
    return fetch('/api/greeting')
    .then(res => res.json())
    .then(json => {
      return `${json.message} ${this._name}`;
    });
  }
}
```

app/scripts/app.js


```javascript
import Hoge from './Hoge';

const hoge = new Hoge('test');

console.log(hoge.greet());

hoge.fetchGreet()
.then(message => {
  console.log(message);
});
```

### APIサーバをモックする

```
$ npm install --save-dev json-schema-mockserve
```

gulpfile.js

```javascript

-- 中略 --

var MockServe = require('json-schema-mockserve').MockServe;

-- 中略 --

gulp.task('serve', () => {
  var port = process.env.API_PORT || 3000;

  if (process.env.MOCK) {
    new MockServe({
      port: port,
      path: path.join(__dirname, 'fixture', 'api.json')
    }).start();
  }

  $.livereload.listen();
  connect()
  .use(connectLivereload())
  .use(serveStatic(distDir))
  .use(proxyMiddleware([
    '/api'
  ], {
    target: 'http://localhost:' + port,
    changeOrigin: true
  }))
  .listen(3100);
});

-- 中略 --
```

fixture/api.json

```json
{
  "$schema": "http://interagent.github.io/interagent-hyper-schema",
  "type": [
    "object"
  ],
  "definitions": {
    "greeting": {
      "$schema": "http://json-schema.org/draft-04/hyper-schema",
      "title": "Greeting",
      "description": "ご挨拶API",
      "stability": "prototype",
      "strictProperties": true,
      "type": [
        "object"
      ],
      "definitions": {
        "message": {
          "description": "ご挨拶メッセージ",
          "example": "こんにちは",
          "type": [
            "string"
          ]
        }
      },
      "links": [
        {
          "description": "ご挨拶メッセージを取得する",
          "href": "/api/greeting",
          "method": "GET",
          "rel": "self",
          "title": "Info"
        }
      ],
      "properties": {
        "message": {
          "$ref": "#/definitions/greeting/definitions/message"
        }
      }
    }
  },
  "properties": {
    "greeting": {
      "$ref": "#/definitions/greeting"
    }
  }
}
```

package.json

```json
-- 中略 --
  "scripts": {
    "gulp": "gulp",
    "gulp:mock": "MOCK=ON gulp",
    "build": "gulp build",
    "mocha": "mocha",
    "test": "mocha test/*-test.js"
  },
-- 中略 --
```

## ブラウザでテストする

```
$ npm install --save-dev testem glob json-loader
```

webpack.test.config.js

```javascript
var path = require('path');
var glob = require('glob');

module.exports = {
  entry: {
    test: glob.sync(path.join(__dirname, 'test/**/*-test.js'))
  },
  output: {
    path: path.join(__dirname, '.powered-assert'),
    filename: '[name].js'
  },
  devtool: 'inline-source-map',
  module: {
    loaders: [
      {
        test: /\.js$/,
        exclude: /node_modules/,
        loader: 'babel'
      },
      {
        test: /\.json$/,
        loader: 'json'
      }
    ]
  }
};
```

testem.json

```json
{
  "framework": "mocha",
  "before_tests": "webpack --config webpack.test.config.js",
  "on_exit": "rm -rf .powered-assert/",
  "src_files": [
    ".powered-assert/**/*.js"
  ]
}
```

.gitignore

```
dist
build
.powered-assert/

-- 中略 --
```

package.json

```json
-- 中略 --
  "scripts": {
    "gulp": "gulp",
    "gulp:mock": "MOCK=ON gulp",
    "build": "gulp build",
    "mocha": "mocha",
    "testem": "testem",
    "test": "mocha test/*-test.js"
  },
-- 中略 --
```
